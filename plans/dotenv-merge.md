# Dotenv generation + safe patching and merge rules (MVP)

This spec defines how KeyClave generates new dotenv files and safely patches existing dotenv files in project folders.

It is written with **recommended defaults** (marked) plus configuration options.

Related:

- Scope: [`plans/product-scope.md`](plans/product-scope.md:1)
- Architecture: [`plans/architecture-module-boundaries.md`](plans/architecture-module-boundaries.md:1)
- Security: [`plans/security-crypto-2fa.md`](plans/security-crypto-2fa.md:1)
- Provider env vars: [`plans/provider-plugins-and-github.md`](plans/provider-plugins-and-github.md:1)

## 1) Supported target files

### Recommended default
- Support `.env` and `.env.*` files (examples: `.env.local`, `.env.production`).

### Options
- Optionally support `*.env` (example: `backend.env`) as a later enhancement.

Rationale:

- `.env` + `.env.*` covers common patterns across Node, Python, and frameworks.

## 2) Parsing rules

### Format support

MVP parser supports:

- `KEY=VALUE`
- `KEY="VALUE"` and `KEY='VALUE'` (basic quotes)
- `export KEY=VALUE` (common in shell docs)
- Comment lines starting with `#`
- Blank lines

Non-goals for MVP:

- Full shell parsing.
- Complex multi-line values.

#### Safe fallback for unparseable lines

If the parser encounters lines it cannot parse (e.g., multi-line values, heredoc syntax):

- Preserve the raw lines verbatim in the AST as opaque blocks.
- Never modify or delete opaque blocks during patching.
- Warn the user that some lines could not be parsed and will be preserved as-is.
- This ensures the parser does not corrupt files containing multi-line RSA keys or other complex values.

### Variable expansion

#### Recommended default
- Treat values as **opaque strings**.

Interpretation:

- Do not resolve `${VAR}`.
- Preserve `${VAR}` syntax if present.

Rationale:

- Avoid surprising runtime behavior changes.
- Reduces risk of leaking values via expansion.

## 3) Formatting preservation and rewrite strategy

### Recommended default
- Preserve original ordering and comments **where possible**.

Implementation approach:

- Parse into an AST-like structure (lines/tokens) preserving:
  - original whitespace
  - comments
  - unknown keys
- Only modify the minimal set of lines necessary.

### Canonical rewrite (optional)

Offer a “Rewrite to canonical format” advanced option:

- Sort keys
- Normalize spacing
- Remove duplicate blank lines

This should be opt-in because it can create noisy diffs.

## 4) Merge policy

KeyClave must support three merge behaviors when a key already exists in the target file.

### Recommended default
- **Prompt per key**.

UI should show a per-key decision with:

- existing value (masked)
- vault value (masked)
- action: keep existing / overwrite / skip

### Alternatives
- Keep existing always
- Overwrite always

## 5) Duplicate keys in dotenv

Dotenv files sometimes contain duplicate keys.

### Recommended default

- Detect duplicates.
- Warn user.
- Default behavior:
  - keep the **last assignment** as the effective value
  - when patching, only update the last effective assignment

## 6) Conflicts between alias env vars (provider-specific)

Example: GitHub supports both `GITHUB_TOKEN` and `GH_TOKEN`.

### Recommended default

- If both exist in the same file:
  - warn
  - require user to choose which canonical key to keep active
  - do not silently delete either in MVP

## 7) Diff preview and backups

### Required safety guarantees (recommended defaults)

- Always create a timestamped backup before writing.
- Always show a diff preview before applying.

Backup behavior:

- Backup adjacent to target file (or in a dedicated `.keyclave-backups/` folder), e.g.:
  - `.env.keyclave.bak.2026-02-06T142500Z`

Backup retention:

- Keep a maximum of **10 backups** per target file by default.
- When the limit is exceeded, delete the oldest backup before creating a new one.
- User may configure the max backup count (minimum 1).

Diff preview:

- Show line-level diff.
- Mask secret values in the preview.

## 8) Atomic writes

Writing must be atomic to reduce corruption risk.

Recommended approach:

1) Write to temporary file in same directory.
2) Flush + fsync.
3) Rename/replace.

## 9) Line endings and encoding

### Recommended default

- Preserve the file’s existing line endings.
  - If the file is CRLF, keep CRLF.
  - If LF, keep LF.

- Preserve UTF-8.

Rationale:

- Minimizes diffs and avoids platform-specific surprises, especially on Windows.

## 10) Generation rules

When generating a new dotenv file:

### Recommended default

- Include a header comment explaining it was generated by KeyClave.
- Write keys in provider-grouped blocks.
- Write canonical env var names by default (per provider spec), e.g. `GITHUB_TOKEN`.

## 11) Acceptance criteria

- Patch does not delete unknown keys.
- Patch preserves comments and ordering where feasible.
- Always creates a backup and always shows a diff preview.
- Writes are atomic.
- Secret values are masked in previews and logs.
